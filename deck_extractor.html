<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>晴れる屋デッキ一括抽出ツール</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { font-size: 22px; margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        
        /* 入力エリア */
        .input-area { margin-bottom: 20px; }
        .search-area { 
            margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed #eee; 
            background-color: #f9fbfd; padding: 15px; border-radius: 5px;
        }

        textarea.url-list { 
            width: 100%; height: 150px; padding: 10px; 
            border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
            font-family: monospace; font-size: 13px;
        }
        
        input[type="text"] {
            width: 70%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
        }

        /* 操作ボタン */
        .controls { margin-bottom: 20px; }
        button { background-color: #007bff; color: white; padding: 10px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .btn-secondary { background-color: #17a2b8; font-size: 14px; padding: 9px 15px;}
        .btn-secondary:hover { background-color: #138496; }

        /* 進捗バー */
        .progress-container { width: 100%; background-color: #e9ecef; border-radius: 4px; margin-bottom: 10px; display: none; }
        .progress-bar { width: 0%; height: 20px; background-color: #28a745; border-radius: 4px; transition: width 0.3s; }
        #statusText { font-weight: bold; margin-bottom: 5px; display: block; font-size: 14px; }
        #searchStatus { font-size: 13px; margin-left: 10px; color: #666; }

        /* 結果エリア */
        textarea.output-result { 
            width: 100%; height: 400px; padding: 10px; 
            border: 1px solid #ccc; border-radius: 4px; 
            font-family: monospace; background-color: #fafafa; box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>晴れる屋デッキ一括抽出</h1>
    
    <div class="search-area">
        <label><strong>1. 検索結果URLからリストを取得</strong></label><br>
        <div style="margin-top: 5px; display: flex; align-items: center;">
            <input type="text" id="searchUrl" placeholder="https://www.hareruyamtg.com/ja/deck/result?..." value="">
            <button onclick="getUrlsFromSearch()" class="btn-secondary" style="margin-left: 10px;">リストを取得</button>
        </div>
        <div id="searchStatus"></div>
    </div>

    <div class="input-area">
        <label><strong>2. デッキURLリスト</strong>（自動入力または手動入力）:</label><br>
        <textarea id="urlList" class="url-list" placeholder="ここにURLがリストアップされます..."></textarea>
    </div>

    <div class="controls">
        <button id="runBtn" onclick="processUrls()">3. 一括抽出を開始</button>
        <button onclick="copyToClipboard()" style="background-color: #6c757d; margin-left: 10px;">結果をコピー</button>
    </div>

    <span id="statusText">待機中...</span>
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <textarea id="output" class="output-result" placeholder="ここに抽出結果が表示されます..."></textarea>
</div>

<script>
    // 待機用関数
    const sleep = msec => new Promise(resolve => setTimeout(resolve, msec));

    // ★追加：検索結果ページからデッキURLを取得する関数
    async function getUrlsFromSearch() {
        const searchInput = document.getElementById('searchUrl');
        const targetList = document.getElementById('urlList');
        const statusLabel = document.getElementById('searchStatus');
        
        const url = searchInput.value.trim();

        if (!url) { 
            alert("検索結果ページのURLを入力してください"); 
            return; 
        }

        statusLabel.textContent = "検索ページを読み込み中...";
        statusLabel.style.color = "blue";

        // CORS回避用プロキシ
        const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;

        try {
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("Network response was not ok");
            
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");

            // デッキ詳細へのリンクを収集 (href="/ja/deck/xxxxx/show/")
            const links = doc.querySelectorAll('a[href*="/deck/"][href*="/show/"]');
            const uniqueUrls = new Set();

            links.forEach(link => {
                let href = link.getAttribute('href');
                // 相対パスを絶対パスに変換
                if (href.startsWith('/')) {
                    href = 'https://www.hareruyamtg.com' + href;
                }
                uniqueUrls.add(href);
            });

            if (uniqueUrls.size === 0) {
                statusLabel.textContent = "デッキURLが見つかりませんでした。(非公開リストやログインが必要なページの可能性があります)";
                statusLabel.style.color = "red";
                return;
            }

            // テキストエリアにセット
            targetList.value = Array.from(uniqueUrls).join('\n');
            statusLabel.textContent = `成功！ ${uniqueUrls.size} 件のデッキURLを取得しました。下のボタンで抽出を開始してください。`;
            statusLabel.style.color = "green";

        } catch (e) {
            console.error(e);
            statusLabel.textContent = "取得エラー: " + e.message;
            statusLabel.style.color = "red";
        }
    }

    // 既存：各デッキURLからカードリストを抽出する関数
    async function processUrls() {
        const urlListText = document.getElementById('urlList').value;
        const urls = urlListText.split('\n').map(u => u.trim()).filter(u => u.length > 0);
        
        const outputArea = document.getElementById('output');
        const statusText = document.getElementById('statusText');
        const runBtn = document.getElementById('runBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        if (urls.length === 0) {
            alert("URLリストが空です。検索から取得するか入力してください。");
            return;
        }

        // 初期化
        outputArea.value = "";
        runBtn.disabled = true;
        progressContainer.style.display = 'block';
        let results = [];
        let successCount = 0;

        for (let i = 0; i < urls.length; i++) {
            const currentUrl = urls[i];
            const progressPercent = Math.round(((i) / urls.length) * 100);
            
            progressBar.style.width = `${progressPercent}%`;
            statusText.textContent = `処理中 (${i + 1}/${urls.length}): ${currentUrl}`;

            try {
                // 1. データ取得
                const extractedData = await fetchDeckData(currentUrl);
                
                // 結果に追加
                results.push(`### Deck ${i + 1}: ${extractedData.title}\n${currentUrl}\n--------------------------\n${extractedData.list}\n`);
                successCount++;

            } catch (err) {
                console.error(err);
                results.push(`### Deck ${i + 1}: 取得失敗\n${currentUrl}\nエラー: ${err.message}\n--------------------------\n`);
            }

            // リアルタイムで結果を表示更新
            outputArea.value = results.join("\n");
            outputArea.scrollTop = outputArea.scrollHeight; 

            // 最後のURLでなければ待機（ブロック回避のため）
            if (i < urls.length - 1) {
                await sleep(1500); 
            }
        }

        // 完了処理
        progressBar.style.width = "100%";
        statusText.textContent = `完了！ (${successCount}/${urls.length} 件成功)`;
        runBtn.disabled = false;
    }

    async function fetchDeckData(targetUrl) {
        const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`;
        
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
        
        const htmlContent = await response.text();
        if (htmlContent.length < 500) throw new Error("データが空、またはブロックされました");

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, "text/html");

        let deckTitle = "No Title";
        const titleEl = doc.querySelector('.deck_header_name') || doc.querySelector('h1');
        if (titleEl) deckTitle = titleEl.textContent.trim();

        let listText = "";
        const rows = doc.querySelectorAll('.deck_unit_table tr');

        if (rows.length > 0) {
            rows.forEach(row => {
                const countEl = row.querySelector('.deck_unit_count');
                const nameEl = row.querySelector('.deck_unit_card a') || row.querySelector('.deck_unit_card');
                if (countEl && nameEl) {
                    listText += `${countEl.textContent.trim()}\t${nameEl.textContent.trim()}\n`;
                }
            });
        } else {
            const bodyText = doc.body.textContent;
            const regex = /([0-9]+)\s+《(.*?)》/g;
            let match;
            while ((match = regex.exec(bodyText)) !== null) {
                listText += `${match[1]}\t${match[2]}\n`;
            }
        }

        if (!listText) throw new Error("カード名が見つかりませんでした");
        
        return { title: deckTitle, list: listText };
    }

    function copyToClipboard() {
        const outputArea = document.getElementById('output');
        outputArea.select();
        document.execCommand('copy');
        alert("クリップボードにコピーしました");
    }
</script>

</body>
</html>
